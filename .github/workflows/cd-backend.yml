name: CD Backend Symfony

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - sit
          - uat
          - prod

jobs:
  build:
    name: Build backend for ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          extensions: mbstring, pdo_pgsql, intl  
          coverage: none

      - name: ğŸ“¦ Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --no-dev

      - name: âš™ï¸ Prepare Symfony (prod)
        env:
          APP_ENV: prod
          APP_SECRET: ${{ secrets.APP_SECRET }}
        run: |
          php bin/console cache:clear
          php bin/console cache:warmup

      - name: ğŸ“¦ Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-${{ github.event.inputs.environment }}-${{ github.run_number }}
          path: |
            .
            !.git
            !var/cache
            !var/log
          retention-days: 30

  deploy-sit:
    name: Deploy to SIT
    needs: build
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'sit'
    environment:
      name: sit

    steps:
      - name: ğŸ“¥ Download artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-sit-${{ github.run_number }}

      - name: ğŸš€ Deploy SIT (simulation)
        run: |
          echo "ğŸš€ DÃ©ploiement backend vers SIT"
          echo "ğŸ“¦ Artefacts prÃªts"
          echo "DÃ©ploiement SIT simulÃ©"

  deploy-uat:
    name: Deploy to UAT
    needs: build
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'uat'
    environment:
      name: uat

    steps:
      - name: ğŸ“¥ Download artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-uat-${{ github.run_number }}

      - name: ğŸš€ Deploy UAT (simulation)
        run: |
          echo "ğŸš€ DÃ©ploiement backend vers UAT"
          echo "ğŸ“¦ Artefacts prÃªts"
          echo "DÃ©ploiement UAT simulÃ©"

  deploy-prod:
    name: Deploy to Production
    needs: build
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'prod'
    environment:
      name: prod

    steps:
      - name: ğŸ“¥ Download artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-prod-${{ github.run_number }}

      - name: ğŸ’¾ Backup production (simulated)
        run: |
          echo "ğŸ’¾ Backup base de donnÃ©es"
          echo "ğŸ’¾ Backup code applicatif"
          echo "Backup simulÃ©"

      - name: ğŸš€ Deploy PROD (simulation)
        run: |
          echo "ğŸš€ DÃ©ploiement backend vers PROD"
          echo "ğŸ“¦ Artefacts prÃªts"
          echo "DÃ©ploiement PROD simulÃ©"

      - name: ğŸ§ª Post-deploy checks
        run: |
          echo "ğŸ§ª VÃ©rification API /health"
          echo "ğŸ§ª Connexion DB"
          echo "VÃ©rifications simulÃ©es OK"