name: CI Backend Symfony #nom du fichier dans github action

# le CI se lance quand on push sur main et quans on ouvre une PR vers main --> Chaque modif critique automatiquement v√©rifi√©e
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  backend:
    runs-on: ubuntu-latest

# github lance un conteneur MySQL temporaire comme docker
  
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: followup_test
          MYSQL_USER: follow_user
          MYSQL_PASSWORD: root
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -u follow_user -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4 # github clone le repo dan sla machine CI

      - name: üêò Setup PHP 
        uses: shivammathur/setup-php@v2 # installe PHP + extensions
        with:
          php-version: '8.3'
          extensions: mbstring, pdo_mysql
          coverage: none

      - name: üì¶ Installer les d√©pendances Composer
        run: composer install --no-interaction --prefer-dist --no-scripts


      - name: ‚öôÔ∏è Pr√©parer l‚Äôenvironnement Symfony
        env:
          APP_ENV: test
          APP_SECRET: ${{ secrets.APP_SECRET }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_PASSPHRASE: ${{ secrets.JWT_PASSPHRASE }}
          MAILER_DSN: ${{ secrets.MAILER_DSN }}
        run: |
          touch .env
          php bin/console cache:clear


      - name: üß© V√©rifier le sch√©ma Doctrine
        env:
          APP_ENV: test
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SYMFONY_DOTENV_VARS: ""
        run: php bin/console doctrine:schema:validate --skip-sync

      - name: üß™ Lancer les tests PHPUnit
        env:
          APP_ENV: test
          APP_SECRET: ${{ secrets.APP_SECRET }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_PASSPHRASE: ${{ secrets.JWT_PASSPHRASE }}
          MAILER_DSN: ${{ secrets.MAILER_DSN }}
          SYMFONY_DOTENV_VARS: ""
        run: php bin/phpunit